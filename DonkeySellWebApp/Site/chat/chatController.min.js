"use strict";function chatController(n,t,i,r,u,f,e,o){n.usernameLike="";n.foundUsers=[];n.onlineFriends=[];n.friends=[];n.loading=!0;n.connectError=!1;n.newGeneralMessage="";n.generalMessages=[];n.privateChatUsers=[];n.privateMessages={};n.noUsersFound=!1;var s;$.connection.hub.qs={access_token:t.get("token")};$.connection.hub.url="http://spiri91-001-site1.ftempurl.com/signalr";setTimeout(function(){$.connection.hub.start({jsonp:!0}).done(function(){n.chatHub.server.findOnlineFriends(n.$parent.username);n.chatHub.server.sendOnlineNotification(n.$parent.username);n.loading=!1}).fail(function(){n.$apply(()=>{n.connectError=!0})})},1e4);n.chatHub=$.connection.chatHub;n.openMenu=function(n,t){s=t;n(t)};o.$on("logout",function(){$.connection.hub.stop()});n.searchForUsers=function(){n.usernameLike.length>=4&&i.usersLike(n.usernameLike).then(function(t){t.data&&(t.data.length>0?(n.noUsersFound=!1,n.foundUsers=t.data):n.noUsersFound=!0)},function(t){n.doSomethingWithError(t)})};n.addToFriends=function(i){if(i!==n.$parent.username&&$.inArray(i,n.friends)===-1){let u=t.get("token");r.postFriend(n.$parent.username,i,u).then(function(){n.chatHub.server.checkIfUserIsOnline(i);n.friends.push(i);f.success("Added!")},function(t){n.doSomethingWithError(t)})}else f.error("Allready added!")};n.openConversation=function(t){n.privateChatUsers.indexOf(t)===-1&&(n.privateChatUsers.push(t),n.privateMessages[t]=[])};n.init=function(){n.getFriends()};n.goToUserProfile=function(n){e.url("/user/"+n)};n.getFriends=function(){let i=t.get("token");r.getFriends(n.$parent.username,i).then(function(t){t.data&&(n.friends=t.data)},function(t){n.doSomethingWithError(t)})};n.removeFriend=function(i){var e=u.confirm().title("Are you sure you want to delete him?! :(").ok("Yes, i'm sure!").cancel("No!");u.show(e).then(function(){let u=t.get("token");r.deleteFriend(n.$parent.username,i,u).then(function(){let t=n.onlineFriends.indexOf(i);n.onlineFriends.splice(t,1);t=n.friends.indexOf(i);n.friends.splice(t,1);f.success("Removed!")},function(t){n.doSomethingWithError(t)})})};n.sendPrivateMessage=function(t){let r="private"+t,i=document.getElementById(r).value;if(i){let u=new PrivateMessage(Date.now(),n.$parent.username,i);n.$apply(function(){n.privateMessages[t].push(u)});n.chatHub.server.sendPrivateMessage(i,t);document.getElementById(r).value="";let f="chatWith"+t;n.scrollIntoView(f)}};n.closeConversation=function(t){let i=n.privateChatUsers.indexOf(t);n.privateChatUsers.splice(i,1)};n.sendGeneralMessage=function(){n.newGeneralMessage&&(n.chatHub.server.sendMessageToAll(n.newGeneralMessage),n.newGeneralMessage="")};n.chatHub.client.addGeneralMessage=function(t,i){let r=new GeneralMessage(t,i);n.$apply(function(){n.generalMessages.push(r)});n.scrollIntoView("chatDiv")};n.scrollIntoView=function(n){let t=document.getElementById(n);t.scrollTop=t.scrollHeight};n.chatHub.client.addPrivateMessage=function(t,i){n.$apply(function(){n.openConversation(t);let r=new PrivateMessage(Date.now(),t,i);n.privateMessages[t].push(r)});let r="chatWith"+t;n.scrollIntoView(r)};n.chatHub.client.addOnlineUser=function(t){n.$apply(function(){n.onlineFriends.push(t)})};n.chatHub.client.addStatusNottification=function(t,i){f.warning(t+" is now "+i);let r=n.onlineFriends.indexOf(t);i==="Online"?(r===-1&&n.$apply(function(){n.onlineFriends.push(t)}),n.privateChatUsers.indexOf(t)!==-1&&n.chatHub.client.addPrivateMessage(t," is online!")):(r>=0&&n.$apply(function(){n.onlineFriends.splice(r,1)}),n.privateChatUsers.indexOf(t)!==-1&&n.chatHub.client.addPrivateMessage(t," is offline!"))};n.doSomethingWithError=function(n){console.log(n)};n.init()}function GeneralMessage(n,t){this.sender=n;this.value=t}function PrivateMessage(n,t,i){this.id=n;this.sender=t;this.value=i}app.controller("chatController",["$scope","storageService","othersService","friendsService","$mdDialog","toastr","$location","$rootScope",chatController]);